<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AstroPop">

    <!-- √çcone do App para quando for instalado no celular -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">

    <title>Orion</title>
    <script src="guard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

        :root {
            --space-bg: #020617;
            --accent-cyan: #22d3ee;
            --deep-blue: #1e40af;
            --slate-white: #f8fafc;
            --cat-body: #1e293b;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: var(--space-bg);
            color: var(--slate-white);
            margin: 0;
            overflow-x: hidden;
            overscroll-behavior-y: contain;
            /* Previne o "puxar para atualizar" que atrapalha apps */
            touch-action: pan-x pan-y;
        }

        #star-canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
            width: 100%;
            height: 100%;
        }

        .glass-card {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(34, 211, 238, 0.1);
            border-radius: 2rem;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.7);
        }

        .nebula-text {
            background: linear-gradient(to right, #22d3ee, #60a5fa, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-space {
            background: linear-gradient(135deg, #0e7490 0%, #1e40af 100%);
            box-shadow: 0 4px 20px rgba(14, 116, 144, 0.4);
        }

        /* --- SISTEMA DO ASTRO POP CAT --- */
        #pet-container {
            position: fixed;
            bottom: 88px;
            left: 0;
            width: 100%;
            height: 110px;
            pointer-events: none;
            z-index: 1000;
        }

        #space-cat {
            position: absolute;
            bottom: 0;
            left: 20px;
            width: 90px;
            height: 90px;
            pointer-events: auto;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .cat-visual {
            width: 100%;
            height: 100%;
            position: relative;
        }

        @keyframes cat-float {

            0%,
            100% {
                transform: translateY(0) rotate(0);
            }

            50% {
                transform: translateY(-8px) rotate(2deg);
            }
        }

        @keyframes tail-wag {

            0%,
            100% {
                transform: rotate(0);
            }

            50% {
                transform: rotate(15deg);
            }
        }

        .is-active {
            animation: cat-float 2s infinite ease-in-out;
        }

        .cat-speech {
            background: white;
            color: #020617;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 800;
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .show-speech .cat-speech {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .tab-active {
            color: #22d3ee !important;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        select,
        input {
            appearance: none;
            background: rgba(255, 255, 255, 0.05) !important;
            color: white !important;
        }

        option {
            background: #0f172a;
            color: white;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            max-width: 320px;
            margin: 0 auto;
            aspect-ratio: 1 / 1;
        }


        .chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>

<body class="no-scrollbar">

    <canvas id="star-canvas"></canvas>

    <!-- ASTRO POP CAT -->
    <div id="pet-container">
        <div id="space-cat" class="is-active" onclick="popCat()">
            <div class="cat-speech" id="cat-bubble">Miau!</div>
            <div class="cat-visual">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="overflow: visible;">
                    <path d="M75 75 Q 95 65 85 45" stroke="#1e293b" stroke-width="8" fill="none" stroke-linecap="round"
                        style="animation: tail-wag 1.5s infinite ease-in-out; transform-origin: 75px 75px;" />
                    <rect x="25" y="82" width="12" height="12" rx="5" fill="#1e293b" />
                    <rect x="55" y="82" width="12" height="12" rx="5" fill="#1e293b" />
                    <rect x="20" y="45" width="55" height="40" rx="15" fill="#1e293b" />
                    <circle cx="47" cy="40" r="25" fill="#1e293b" />
                    <path d="M30 22 L20 2 L42 18 Z" fill="#1e293b" />
                    <path d="M64 22 L74 2 L52 18 Z" fill="#1e293b" />
                    <circle cx="37" cy="42" r="4" fill="#22d3ee" />
                    <circle cx="57" cy="42" r="4" fill="#22d3ee" />
                    <g stroke="white" stroke-width="1.5" opacity="0.6">
                        <line x1="32" y1="48" x2="10" y2="45" />
                        <line x1="32" y1="51" x2="8" y2="54" />
                        <line x1="62" y1="48" x2="84" y2="45" />
                        <line x1="62" y1="51" x2="86" y2="54" />
                    </g>
                    <g id="mouth-closed">
                        <path d="M42 52 Q 47 56 52 52" stroke="#e08e8e" stroke-width="2" fill="none" />
                    </g>
                    <g id="mouth-open" style="display: none;">
                        <circle cx="47" cy="55" r="8" fill="#4a1a1a" />
                    </g>
                    <rect x="30" y="78" width="10" height="12" rx="4" fill="#334155" />
                    <rect x="52" y="78" width="10" height="12" rx="4" fill="#334155" />
                    <circle cx="47" cy="40" r="32" fill="rgba(34, 211, 238, 0.12)" stroke="rgba(255, 255, 255, 0.3)"
                        stroke-width="2" />
                    <path d="M30 25 Q 47 15 64 25" stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.4"
                        fill="none" />
                </svg>
            </div>
        </div>
    </div>

    <header class="p-8 pt-16 pb-6 text-center">
        <p class="text-slate-500 text-[10px] font-bold uppercase tracking-[0.4em] mb-2">Comando de √ìrbita</p>
        <h1 id="main-balance" class="text-5xl font-bold tracking-tighter mb-8">R$ 0,00</h1>

        <div class="grid grid-cols-2 gap-4">
            <div class="glass-card p-4 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-cyan-400"></div>
                <p class="text-[9px] text-slate-500 font-black uppercase mb-1">Entradas</p>
                <p id="total-income" class="text-cyan-400 font-bold text-lg">R$ 0,00</p>
            </div>
            <div class="glass-card p-4 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-slate-500"></div>
                <p class="text-[9px] text-slate-500 font-black uppercase mb-1">Sa√≠das</p>
                <p id="total-expense" class="text-slate-300 font-bold text-lg">R$ 0,00</p>
            </div>
        </div>
    </header>

    <main class="px-6 pb-32">
        <section id="view-dashboard" class="space-y-6">
            <div class="glass-card p-6 space-y-4">
                <div class="flex justify-between items-end">
                    <div>
                        <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Consumo de
                            Combust√≠vel</h3>
                        <p id="burn-rate-text" class="text-xl font-bold text-white">0%</p>
                    </div>
                </div>
                <div class="h-[6px] bg-white/5 rounded-full overflow-hidden">
                    <div id="burn-rate-fill" class="h-full bg-cyan-400 transition-all duration-1000" style="width: 0%">
                    </div>
                </div>
            </div>
            <div id="transactions-list" class="space-y-4"></div>
        </section>

        <section id="view-add" class="hidden space-y-6">
            <div class="glass-card p-8 space-y-6">
                <h2 class="text-2xl font-bold nebula-text">Novo Registo</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-[9px] font-bold text-slate-500 uppercase ml-2">Identifica√ß√£o do
                            Objeto</label>
                        <input type="text" id="desc"
                            class="w-full bg-white/5 border border-white/10 rounded-2xl p-5 outline-none mt-1"
                            placeholder="Ex: Ra√ß√£o, Aluguel da Nave...">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase ml-2">Massa (Valor)</label>
                            <input type="number" id="val"
                                class="w-full bg-white/5 border border-white/10 rounded-2xl p-5 outline-none mt-1"
                                placeholder="0.00">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase ml-2">Trajet√≥ria</label>
                            <select id="type"
                                class="w-full bg-white/5 border border-white/10 rounded-2xl p-5 outline-none mt-1">
                                <option value="income">Entrada</option>
                                <option value="expense" selected>Sa√≠da</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="text-[9px] font-bold text-slate-500 uppercase ml-2">Setor (Categoria)</label>
                        <select id="category"
                            class="w-full bg-white/5 border border-white/10 rounded-2xl p-5 outline-none mt-1">
                            <option value="food">üç± Alimenta√ß√£o (Ra√ß√£o)</option>
                            <option value="transport">üöÄ Transporte (Combust√≠vel)</option>
                            <option value="home">üè† Base (Moradia)</option>
                            <option value="leisure">üéÆ Lazer Estelar</option>
                            <option value="work">üíº Miss√£o (Trabalho)</option>
                            <option value="others">üåå Outros</option>
                        </select>
                    </div>
                </div>
                <button onclick="addTransaction()"
                    class="w-full btn-space text-white font-bold py-5 rounded-2xl transition-transform active:scale-95">Lan√ßar
                    no Sistema</button>
            </div>
        </section>

        <section id="view-plan" class="hidden">
            <div class="glass-card p-6 border border-cyan-500/10 text-center">
                <h3 class="font-bold text-cyan-400">üìä Relat√≥rios de Navega√ß√£o</h3>
                <p class="text-slate-500 text-sm mt-2">Dados de telemetria sincronizados com sucesso.</p>
                <div class="mt-8">
                    <button onclick="clearData()"
                        class="text-[10px] text-rose-500 font-bold border border-rose-900/30 px-4 py-2 rounded-full">REINICIAR
                        UNIVERSO</button>
                </div>
                <!-- Filtros -->
                <div class="flex gap-4 mb-4">
                    <select id="filter-month"
                        class="w-1/2 bg-white/5 border border-white/10 rounded-2xl p-2 text-white">
                        <option value="">Todos os meses</option>
                        <option value="0">Janeiro</option>
                        <option value="1">Fevereiro</option>
                        <option value="2">Mar√ßo</option>
                        <option value="3">Abril</option>
                        <option value="4">Maio</option>
                        <option value="5">Junho</option>
                        <option value="6">Julho</option>
                        <option value="7">Agosto</option>
                        <option value="8">Setembro</option>
                        <option value="9">Outubro</option>
                        <option value="10">Novembro</option>
                        <option value="11">Dezembro</option>
                    </select>
                    <select id="filter-year" class="w-1/2 bg-white/5 border border-white/10 rounded-2xl p-2 text-white">
                        <option value="">Todos os anos</option>
                    </select>
                </div>
                <div class="mt-6 chart-wrapper">
                    <canvas id="lineChart"></canvas>
                </div>
                <div class="mt-6 chart-wrapper">
                    <canvas id="categoryChart"></canvas>
                </div>

                <button onclick="logout()"
                    class="mt-6 text-[10px] text-slate-400 font-bold border border-white/10 px-4 py-2 rounded-full">
                    SAIR DA CONTA
                </button>
            </div>
        </section>
    </main>

    <nav class="fixed bottom-6 left-6 right-6 h-20 glass-card border-white/5 flex justify-around items-center z-50">
        <button onclick="showTab('dashboard')" id="nav-dashboard"
            class="flex flex-col items-center gap-1 flex-1 tab-active">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            <span class="text-[9px] font-bold uppercase">Radar</span>
        </button>
        <button onclick="showTab('add')" id="nav-add" class="flex flex-col items-center flex-1 -mt-12">
            <div
                class="w-14 h-14 rounded-full btn-space flex items-center justify-center text-white border-4 border-[#020617]">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </div>
        </button>
        <button onclick="showTab('plan')" id="nav-plan" class="flex flex-col items-center gap-1 flex-1 text-slate-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-width="2"
                    d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                </path>
            </svg>
            <span class="text-[9px] font-bold uppercase">Dados</span>
        </button>
    </nav>
    <script>
        /* ======================================================
        ==================== ESTRELAS (THREE.JS) ====================
        ====================================================== */
        let scene, camera, renderer, stars;

        function initStars() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

            renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById('star-canvas'),
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);

            const geo = new THREE.BufferGeometry();
            const verts = [];
            for (let i = 0; i < 3000; i++) {
                verts.push((Math.random() - 0.5) * 2000, (Math.random() - 0.5) * 2000, -Math.random() * 2000);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));

            stars = new THREE.Points(
                geo,
                new THREE.PointsMaterial({ color: 0x22d3ee, size: 0.8, transparent: true, opacity: 0.5 })
            );
            scene.add(stars);

            (function anim() {
                requestAnimationFrame(anim);
                stars.rotation.z += 0.0002;
                renderer.render(scene, camera);
            })();
        }

        /* ======================================================
        ==================== CATEGORIAS ====================
        ====================================================== */
        const categoryMap = {
            food: { icon: 'üç±', color: 'bg-orange-500/20 text-orange-400', chartColor: '#fb923c' },
            transport: { icon: 'üöÄ', color: 'bg-blue-500/20 text-blue-400', chartColor: '#3b82f6' },
            home: { icon: 'üè†', color: 'bg-indigo-500/20 text-indigo-400', chartColor: '#6366f1' },
            leisure: { icon: 'üéÆ', color: 'bg-purple-500/20 text-purple-400', chartColor: '#a78bfa' },
            work: { icon: 'üíº', color: 'bg-emerald-500/20 text-emerald-400', chartColor: '#34d399' },
            others: { icon: 'üåå', color: 'bg-slate-500/20 text-slate-400', chartColor: '#94a3b8' }
        };

        /* ======================================================
        ==================== ASTRO POP CAT ====================
        ====================================================== */
        const pet = {
            el: document.getElementById('space-cat'),
            bubble: document.getElementById('cat-bubble'),
            mouthClosed: document.getElementById('mouth-closed'),
            mouthOpen: document.getElementById('mouth-open'),

            say(msg) {
                this.bubble.innerText = msg;
                this.el.parentNode.classList.add('show-speech');
                setTimeout(() => this.el.parentNode.classList.remove('show-speech'), 2500);
            },

            pop() {
                this.mouthClosed.style.display = 'none';
                this.mouthOpen.style.display = 'block';
                setTimeout(() => {
                    this.mouthClosed.style.display = 'block';
                    this.mouthOpen.style.display = 'none';
                }, 150);
            }
        };

        function popCat() {
            pet.pop();
            const balance = getBalance();
            if (balance < 0) pet.say("POP! Estamos no vermelho! üìâ");
            else if (balance > 5000) pet.say("POP! Magnata das estrelas! üíé");
            else pet.say("POP! Miau espacial!");
        }

        /* ======================================================
        ==================== DADOS DO APP ====================
        ====================================================== */
        let transactions = JSON.parse(localStorage.getItem('space_finance_v3')) || [];

        function getBalance() {
            return transactions.reduce((acc, t) => t.type === 'income' ? acc + t.val : acc - t.val, 0);
        }

        /* ======================================================
        ==================== NAVEGA√á√ÉO ====================
        ====================================================== */
        function showTab(id) {
            // Esconde todas as se√ß√µes e ativa a desejada
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
            document.getElementById('view-' + id).classList.remove('hidden');

            // Atualiza bot√£o ativo
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('tab-active');
                b.classList.add('text-slate-500');
            });
            document.getElementById('nav-' + id).classList.add('tab-active');

            // Atualiza dados da UI
            updateUI();

            // Renderiza gr√°fico quando aba "plan" √© aberta
            if (id === "plan") {
                setTimeout(renderCategoryChart, 50);
            }
        }

        /* ======================================================
        ==================== TRANSA√á√ïES ====================
        ====================================================== */
        function addTransaction() {
            const desc = document.getElementById('desc').value;
            const val = parseFloat(document.getElementById('val').value);
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;

            if (!desc || isNaN(val)) return;

            transactions.unshift({
                id: Date.now(),
                desc,
                val,
                type,
                category,
                date: new Date().toLocaleDateString('pt-BR')
            });

            localStorage.setItem('space_finance_v3', JSON.stringify(transactions));

            pet.pop();
            if (type === 'income') {
                pet.say(val > 500 ? "Uau! Grande entrada! üöÄ" : "Mais recursos chegando.");
            } else {
                if (category === 'food') pet.say("Mais ra√ß√£o? Miau! üç±");
                else if (category === 'leisure') pet.say("A divers√£o custa caro! üéÆ");
                else pet.say("Consumo detectado...");
            }

            document.getElementById('desc').value = '';
            document.getElementById('val').value = '';
            showTab('dashboard');
            if (!document.getElementById('view-plan').classList.contains('hidden')) {
                renderCategoryChart();
                renderLineChart();
            }

        }

        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('space_finance_v3', JSON.stringify(transactions));
            updateUI();
            pet.say("Log removido.");
        }

        function clearData() {
            if (confirm("Deseja mesmo colapsar o universo e apagar tudo?")) {
                transactions = [];
                localStorage.removeItem('space_finance_v3');
                updateUI();
                pet.say("Universo reiniciado.");
            }
        }

        /* ======================================================
        ==================== ATUALIZA UI ====================
        ====================================================== */
        function updateUI() {
            const list = document.getElementById('transactions-list');
            const mainBalance = document.getElementById('main-balance');
            const burnText = document.getElementById('burn-rate-text');
            const burnFill = document.getElementById('burn-rate-fill');

            const filtered = filterTransactions(transactions);

            let inc = 0, exp = 0;
            list.innerHTML = '';

            filtered.forEach(t => {
                if (t.type === 'income') inc += t.val;
                else exp += t.val;

                const catInfo = categoryMap[t.category] || categoryMap.others;
                const card = document.createElement('div');
                card.className = 'glass-card p-5 flex justify-between items-center transition-all hover:scale-[1.01]';
                card.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center text-xl ${catInfo.color}">
                    ${catInfo.icon}
                </div>
                <div>
                    <p class="font-bold text-white text-sm">${t.desc}</p>
                    <p class="text-[8px] text-slate-500 uppercase tracking-tighter">${t.date} ‚Ä¢ ${t.category.toUpperCase()}</p>
                </div>
            </div>
            <div class="flex items-center gap-3 text-right">
                <div>
                    <p class="font-bold text-sm ${t.type === 'income' ? 'text-cyan-400' : 'text-slate-300'}">
                        ${t.type === 'income' ? '+' : '-'} R$ ${t.val.toFixed(2)}
                    </p>
                </div>
                <button onclick="deleteTransaction(${t.id})" class="text-slate-700 hover:text-rose-500 ml-2">‚úï</button>
            </div>`;
                list.appendChild(card);
            });

            const total = inc - exp;
            mainBalance.innerText = `R$ ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            mainBalance.style.color = total < 0 ? '#f87171' : 'white';

            document.getElementById('total-income').innerText = `R$ ${inc.toFixed(2)}`;
            document.getElementById('total-expense').innerText = `R$ ${exp.toFixed(2)}`;

            const burn = inc > 0 ? Math.min((exp / inc) * 100, 100) : (exp > 0 ? 100 : 0);
            burnText.innerText = `${burn.toFixed(0)}%`;
            burnFill.style.width = `${burn}%`;
            burnFill.style.backgroundColor = burn > 80 ? '#f87171' : '#22d3ee';
        }

        /* ======================================================
        ==================== GR√ÅFICO DE CATEGORIAS ====================
        ====================================================== */
        let chartInstance = null;

        function renderCategoryChart() {
            const expenses = filterTransactions(transactions).filter(t => t.type === "expense");
            const totals = {};
            expenses.forEach(t => totals[t.category] = (totals[t.category] || 0) + t.val);

            const labels = Object.keys(totals);
            const values = Object.values(totals);

            if (!labels.length) {
                const ctx = document.getElementById("categoryChart");
                if (chartInstance) chartInstance.destroy();
                return;
            }

            const ctx = document.getElementById("categoryChart");
            if (!ctx) return;

            // Destroi gr√°fico antigo se existir
            if (chartInstance) chartInstance.destroy();

            // Cores do gr√°fico
            const backgroundColors = labels.map(l => (categoryMap[l]?.chartColor) || '#64748b');

            const totalExpense = values.reduce((a, b) => a + b, 0);
            const percentages = values.map(v => ((v / totalExpense) * 100).toFixed(1));

            chartInstance = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: labels.map((l, i) => `${l.toUpperCase()} ‚Ä¢ R$ ${values[i].toFixed(2)} (${percentages[i]}%)`),
                    datasets: [{
                        data: values,
                        backgroundColor,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: "white", font: { size: 10 } }
                        }
                    }
                }
            });
        }

        /* ======================================================
        ==================== LOGOUT ====================
        ====================================================== */
        function logout() {
            localStorage.removeItem("orion_logged");
            window.location.replace("login.html");
        }

        /* ======================================================
        ==================== INICIALIZA√á√ÉO ====================
        ====================================================== */
        window.onload = () => {
            initStars();
            updateUI();
            setTimeout(() => pet.say("Setores prontos!"), 1000);

            setInterval(() => {
                if (!document.getElementById('view-add').classList.contains('hidden')) return;
                const b = getBalance();
                if (b < 0) pet.say("Precisamos de mais carga! üîã");
                else if (b > 1000) pet.say("Nave leve e r√°pida! üõ∏");
            }, 18000);

            const yearSelect = document.getElementById('filter-year');
            const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))];
            years.sort((a, b) => b - a); // do mais recente ao mais antigo
            years.forEach(y => {
                const option = document.createElement('option');
                option.value = y;
                option.text = y;
                yearSelect.appendChild(option);
            });

        };

        function filterTransactions(transactions) {
            const month = document.getElementById('filter-month').value;
            const year = document.getElementById('filter-year').value;

            return transactions.filter(t => {
                const d = new Date(t.date);
                const matchMonth = month === "" || d.getMonth() === parseInt(month);
                const matchYear = year === "" || d.getFullYear() === parseInt(year);
                return matchMonth && matchYear;
            });
        }

        let lineChartInstance = null;

        function renderLineChart() {
            const filtered = filterTransactions(transactions);
            // Agrupar por dia
            const daily = {};
            filtered.forEach(t => {
                const key = t.date;
                if (!daily[key]) daily[key] = { income: 0, expense: 0 };
                if (t.type === 'income') daily[key].income += t.val;
                else daily[key].expense += t.val;
            });

            const labels = Object.keys(daily).sort((a, b) => {
                const [da, ma, ya] = a.split('/');
                const [db, mb, yb] = b.split('/');
                return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
            });

            const incomeData = labels.map(d => daily[d].income);
            const expenseData = labels.map(d => daily[d].expense);

            const ctx = document.getElementById('lineChart');
            if (!ctx) return;
            if (lineChartInstance) lineChartInstance.destroy();

            lineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Entradas', data: incomeData, borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.2)', fill: true, tension: 0.3 },
                        { label: 'Sa√≠das', data: expenseData, borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.2)', fill: true, tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: 'white', font: { size: 10 } } }
                    },
                    scales: {
                        x: { ticks: { color: 'white', font: { size: 10 } } },
                        y: { ticks: { color: 'white', font: { size: 10 } }, beginAtZero: true }
                    }
                }
            });
        }

        document.getElementById('filter-month').addEventListener('change', () => {
            updateUI();
            renderCategoryChart();
            renderLineChart();
        });
        document.getElementById('filter-year').addEventListener('change', () => {
            updateUI();
            renderCategoryChart();
            renderLineChart();
        });

    </script>

</body>

</html>